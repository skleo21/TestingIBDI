<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-with, initial-scale=1.0">
    <title>Interactive IBD Test Simulation Report</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- Chosen Palette: "Soothing Neutrals" - A calm and professional palette with off-white, slate grey, and a gentle blue for accents. -->
    <!-- Application Structure Plan: A single-page application with a fixed top navigation bar to switch between three main thematic sections: 'Overview', 'Simulation Scenarios', and 'Code & Setup'. This tabbed structure is chosen to break down the dense report into digestible, task-oriented sections, prioritizing user exploration over the original linear format. The main goal is to allow users to immediately interact with the data in the 'Simulation Scenarios' section, which features a dynamic chart and data cards, while keeping reference material like code and setup instructions neatly organized and accessible in other sections. This enhances usability by preventing information overload and catering to different user goals (e.g., exploring data vs. understanding implementation). -->
    <!-- Visualization & Content Choices: 
        - Report Info: Patient trajectory data (final concentration, c-score, t-score over weeks). Goal: Show change over time. Viz/Presentation: Interactive Line Chart (Chart.js) for 'final_concentration'. Interaction: User selects a patient scenario from a dropdown, which dynamically updates the chart and associated data cards. Justification: A line chart is the clearest way to visualize trends. Making it interactive allows for direct comparison between different patient journeys. Library/Method: Chart.js on a Canvas element.
        - Report Info: Calprotectin reference ranges. Goal: Inform/Provide Context. Viz/Presentation: A styled HTML table placed directly beside the chart. Interaction: Static. Justification: Provides immediate, essential context for interpreting the chart data.
        - Report Info: Python simulation scripts and setup instructions. Goal: Organize/Inform. Viz/Presentation: Accordion-style collapsible sections for code blocks. Interaction: Click to expand/collapse. A 'Copy to Clipboard' button for each code block. Justification: Manages screen real estate effectively and provides a direct utility for developers.
        - Report Info: Patient trajectory data for LLM interpretation. Goal: Provide AI-driven insights. Viz/Presentation: Text output from LLM. Interaction: User clicks a button to send current patient data to Gemini API and displays the generated summary. Justification: Enhances data understanding with contextual AI interpretation, adding value beyond raw visualization. Library/Method: Fetch API with Gemini 2.0 Flash.
        - CONFIRMATION: NO SVG graphics used. NO Mermaid JS used. -->
    <style>
        body { font-family: 'Inter', sans-serif; }
        .chart-container { position: relative; width: 100%; max-width: 900px; margin-left: auto; margin-right: auto; height: 300px; max-height: 40vh; }
        @media (min-width: 768px) { .chart-container { height: 400px; } }
        .nav-button.active { background-color: #3b82f6; color: white; }
        .nav-button { transition: all 0.2s ease-in-out; }
        .loader {
            border-top-color: #3498db;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-slate-50 text-slate-800">

    <div id="app" class="max-w-7xl mx-auto p-4 sm:p-6 lg:p-8">
        
        <header class="text-center mb-8">
            <h1 class="text-3xl md:text-4xl font-bold text-slate-900">Interactive IBD Test Simulation Report</h1>
            <p class="mt-2 text-lg text-slate-600">An explorable interface for the IBD test simulation data and methodology.</p>
        </header>

        <nav class="sticky top-0 z-10 bg-slate-50/80 backdrop-blur-lg mb-8 p-2 border-b border-slate-200 rounded-lg">
            <div id="nav-container" class="flex justify-center items-center space-x-2 sm:space-x-4 bg-slate-100 p-2 rounded-md">
                <button data-target="overview" class="nav-button active px-4 py-2 text-sm sm:text-base font-semibold rounded-md text-slate-700 hover:bg-slate-200">Overview</button>
                <button data-target="scenarios" class="nav-button px-4 py-2 text-sm sm:text-base font-semibold rounded-md text-slate-700 hover:bg-slate-200">Simulation Scenarios</button>
                <button data-target="code" class="nav-button px-4 py-2 text-sm sm:text-base font-semibold rounded-md text-slate-700 hover:bg-slate-200">Code & Setup</button>
            </div>
        </nav>

        <main>
            <section id="overview" class="page-section space-y-6">
                 <div class="bg-white p-6 rounded-lg shadow-sm border border-slate-200">
                    <h2 class="text-2xl font-bold text-slate-800 mb-3">Project Purpose</h2>
                    <p class="text-slate-600">This application visualizes a Python-based simulation tool designed to model Inflammatory Bowel Disease (IBD) test results over time. The primary goal of the simulation is to generate realistic data for Calprotectin (Calpro) and Health Survey tests by allowing manual data input for different user profiles. This enables developers and analysts to validate the data processing pipeline, observe patient trends, and ensure the correctness of outputs after each simulated test. The simulation leverages the `time-machine` library to accurately control timestamps, mimicking how a patient's data would be collected over several weeks.</p>
                </div>
                 <div class="bg-white p-6 rounded-lg shadow-sm border border-slate-200">
                    <h2 class="text-2xl font-bold text-slate-800 mb-3">How to Use This Application</h2>
                    <p class="text-slate-600">Use the navigation bar above to switch between sections. The <span class="font-semibold text-blue-600">Simulation Scenarios</span> section provides an interactive visualization of predefined patient data, allowing you to explore different clinical trajectories. The <span class="font-semibold text-blue-600">Code & Setup</span> section contains the original Python scripts and instructions for running the simulation tool yourself. This interactive format is designed to make the report's key findings and technical details more accessible and engaging than a static document.</p>
                </div>
            </section>

            <section id="scenarios" class="page-section hidden space-y-6">
                <div class="bg-white p-6 rounded-lg shadow-sm border border-slate-200">
                    <h2 class="text-2xl font-bold text-slate-800 mb-4">Patient Trajectory Analysis</h2>
                    <p class="text-slate-600 mb-6">This section allows you to explore different patient scenarios from the simulation. Select a patient case to visualize their Calprotectin concentration over several weeks. The chart illustrates the patient's journey, showing periods of flare, remission, or relapse. Use the reference table to understand the clinical significance of the concentration levels.</p>

                    <div class="mb-6">
                        <label for="scenario-select" class="block text-sm font-medium text-slate-700 mb-2">Select a Patient Scenario:</label>
                        <select id="scenario-select" class="block w-full md:w-1/2 p-2 border border-slate-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                            <option value="flareToRemission">Patient A: Active Flare → Remission</option>
                            <option value="stableToRelapse">Patient B: Stable → Relapse</option>
                            <option value="stable">Patient C: Consistently Stable</option>
                        </select>
                    </div>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    <div class="lg:col-span-2 bg-white p-6 rounded-lg shadow-sm border border-slate-200">
                        <h3 id="chart-title" class="text-xl font-semibold text-center mb-4"></h3>
                        <div class="chart-container">
                            <canvas id="concentrationChart"></canvas>
                        </div>
                    </div>
                    <div class="space-y-6">
                         <div class="bg-white p-6 rounded-lg shadow-sm border border-slate-200">
                            <h3 class="text-xl font-semibold mb-3">Key Metrics</h3>
                             <div class="space-y-3">
                                <div id="metric-c-score" class="text-slate-700"><strong>C-Score:</strong> <span class="font-mono text-blue-600">--</span></div>
                                <div id="metric-t-score" class="text-slate-700"><strong>T-Score:</strong> <span class="font-mono text-blue-600">--</span></div>
                                <div id="metric-concentration" class="text-slate-700"><strong>Concentration:</strong> <span class="font-mono text-blue-600">--</span> µg/g</div>
                                <div id="metric-result" class="text-slate-700"><strong>Overall Result:</strong> <span class="font-mono text-blue-600">--</span></div>
                             </div>
                        </div>
                        <div class="bg-white p-6 rounded-lg shadow-sm border border-slate-200">
                            <h3 class="text-xl font-semibold mb-3">Calprotectin Reference Ranges</h3>
                            <ul class="space-y-2 text-slate-600">
                                <li><span class="font-bold text-green-600">Normal:</span> &lt; 100 µg/g</li>
                                <li><span class="font-bold text-yellow-600">Mild Elevation:</span> 100-250 µg/g</li>
                                <li><span class="font-bold text-orange-600">Moderate Elevation:</span> 250-500 µg/g</li>
                                <li><span class="font-bold text-red-600">Severe Elevation:</span> &gt; 500 µg/g</li>
                            </ul>
                        </div>
                    </div>
                </div>

                <!-- New LLM Interpretation Section -->
                <div class="bg-white p-6 rounded-lg shadow-sm border border-slate-200">
                    <h3 class="text-xl font-semibold mb-3">Patient Insights ✨</h3>
                    <p class="text-slate-600 mb-4">Click the button below to get an AI-generated interpretation of the currently selected patient's test trajectory. This feature leverages a large language model to provide a concise summary of their IBD activity based on their Calprotectin data.</p>
                    <button id="generate-interpretation" class="bg-blue-600 text-white px-6 py-3 rounded-md shadow-md hover:bg-blue-700 transition duration-300 ease-in-out font-semibold">
                        ✨ Generate Patient Trajectory Summary
                    </button>
                    <div id="interpretation-output" class="mt-4 p-4 bg-blue-50 text-blue-800 rounded-md border border-blue-200 hidden">
                        <p id="interpretation-text" class="text-sm italic"></p>
                        <div id="interpretation-loading" class="text-center hidden">
                            <div class="loader ease-linear rounded-full border-4 border-t-4 border-gray-200 h-8 w-8 mb-2"></div>
                            <p>Generating insight...</p>
                        </div>
                    </div>
                </div>
            </section>

            <section id="code" class="page-section hidden space-y-6">
                <div class="bg-white p-6 rounded-lg shadow-sm border border-slate-200">
                    <h2 class="text-2xl font-bold text-slate-800 mb-4">Code & Setup Guide</h2>
                     <p class="text-slate-600 mb-6">This section contains the necessary code and instructions to run the IBD test simulation locally. The primary script establishes a `TestSimulation` class for managing users and their tests, while a secondary script provides predefined scenarios for repeatable experiments. Click on a title to expand the code view.</p>
                </div>
                
                <div class="space-y-4">
                    <div class="accordion-item bg-white rounded-lg border border-slate-200 overflow-hidden">
                        <button class="accordion-header w-full text-left p-4 bg-slate-100 hover:bg-slate-200 transition">
                            <h3 class="text-xl font-semibold">Main Simulation Script (`test_simulation.py`)</h3>
                        </button>
                        <div class="accordion-content hidden p-4">
                            <div class="relative">
                                <button onclick="copyToClipboard('code-block-1')" class="absolute top-2 right-2 bg-slate-200 text-slate-700 px-2 py-1 rounded text-xs font-semibold hover:bg-slate-300">Copy</button>
                                <pre class="bg-slate-800 text-white p-4 rounded-md overflow-x-auto"><code id="code-block-1">
import time_machine
import json
from datetime import datetime, timedelta

# Mock external dependencies for self-contained code snippet
# In a real setup, these would be imported from their respective files.
def calpro_manage_new_calpro_test_result(user_id, test_result):
    # This is a simplified mock. In a real system, this would interact with a database.
    print(f"--- MOCK: Storing Calpro result for user {user_id} ---")
    print(f"  Test data: {test_result}")
    # Simulate a successful response
    return ({'calpro_test_id': 'calpro_' + str(datetime.now().timestamp())}, 200)

def health_survey_manage_new_health_survey(user_id, health_survey):
    # This is a simplified mock. In a real system, this would interact with a database.
    print(f"--- MOCK: Storing Health Survey for user {user_id} ---")
    print(f"  Survey data: {health_survey}")
    # Simulate a successful response with some mock scores
    return ({'health_survey_id': 'hs_' + str(datetime.now().timestamp()), 'sccai_score': 5, 'hbi_score': 3, 'shs_score': 7}, 200)

# Mock HTTP_200_OK for completeness
HTTP_200_OK = 200

class TestSimulation:
    def __init__(self):
        self.users = []
        self.current_date = datetime.now()
        
    def add_user(self, user_id, name):
        """Add a user to the simulation"""
        user_data = {
            'user_id': user_id,
            'name': name,
            'calpro_tests': [],
            'health_surveys': []
        }
        self.users.append(user_data)
        print(f"Added user: {name} (ID: {user_id})")
        
    def simulate_calpro_test(self, user_id, test_date=None):
        """Simulate a Calpro test for a specific user"""
        user = self._find_user(user_id)
        if not user:
            print(f"User {user_id} not found")
            return
            
        if test_date:
            self.current_date = test_date
            
        print(f"\n=== Calpro Test Simulation for {user['name']} ===")
        print(f"Date: {self.current_date.strftime('%Y-%m-%d %H:%M:%S')}")
        
        # Manual input for Calpro test data
        print("Enter Calpro test results:")
        c_score = float(input("C Score: "))
        t_score = float(input("T Score: "))
        overall_result = input("Overall Result (e.g., 'Normal', 'Elevated'): ")
        final_concentration = float(input("Final Concentration (μg/g): "))
        
        test_result = {
            'date': self.current_date.isoformat(),
            'c_score': c_score,
            't_score': t_score,
            'overall_result': overall_result,
            'final_concentration': final_concentration
        }
        
        # Use time machine to simulate the test at the specified date
        with time_machine.travel(self.current_date):
            result, status_code = calpro_manage_new_calpro_test_result(user_id, test_result)
            
            if status_code == HTTP_200_OK:
                test_result['result_id'] = result.get('calpro_test_id')
                user['calpro_tests'].append(test_result)
                print(f"✓ Calpro test recorded successfully (ID: {result.get('calpro_test_id')})")
                print(f"  Final Concentration: {final_concentration} μg/g")
                print(f"  Overall Result: {overall_result}")
            else:
                print(f"✗ Failed to record Calpro test: {result}")
                
    def simulate_health_survey(self, user_id, test_date=None):
        """Simulate a health survey for a specific user"""
        user = self._find_user(user_id)
        if not user:
            print(f"User {user_id} not found")
            return
            
        if test_date:
            self.current_date = test_date
            
        print(f"\n=== Health Survey Simulation for {user['name']} ===")
        print(f"Date: {self.current_date.strftime('%Y-%m-%d %H:%M:%S')}")
        
        # Manual input for health survey data
        health_survey = self._get_health_survey_input()
        
        # Use time machine to simulate the survey at the specified date
        with time_machine.travel(self.current_date):
            result, status_code = health_survey_manage_new_health_survey(user_id, health_survey)
            
            if status_code == HTTP_200_OK:
                health_survey['result_id'] = result.get('health_survey_id')
                health_survey['date'] = self.current_date.isoformat()
                user['health_surveys'].append(health_survey)
                print(f"✓ Health survey recorded successfully (ID: {result.get('health_survey_id')})")
                print(f"  SCCAI Score: {result.get('sccai_score', 'N/A')}")
                print(f"  HBI Score: {result.get('hbi_score', 'N/A')}")
                print(f"  SHS Score: {result.get('shs_score', 'N/A')}")
            else:
                print(f"✗ Failed to record health survey: {result}")
                
    def _get_health_survey_input(self):
        """Get manual input for health survey questions"""
        print("\n--- Health Survey Questions ---")
        
        section_one = []
        section_two = []
        
        # SCCAI Section One Questions (questions 1, 2, 4, 6)
        print("\nSCCAI Questions (Section One):")
        for q_id in [1, 2, 4, 6]:
            score = int(input(f"Question {q_id} score (0-3): "))
            section_one.append({
                "question_id": q_id,
                "answer_score": score
            })
            
        # HBI Section One Questions (questions 3, 5, 8)
        print("\nHBI Questions (Section One):")
        for q_id in [3, 5, 8]:
            score = int(input(f"Question {q_id} score (0-4): "))
            section_one.append({
                "question_id": q_id,
                "answer_score": score
            })
            
        # Section Two Questions (Visual Analog Scale 0-100)
        print("\nSection Two (Visual Analog Scale 0-100):")
        score = int(input("Overall wellbeing score (0-100): "))
        section_two.append({
            "question_id": 1,
            "answer_score": score
        })
        
        return {
            "section_one": section_one,
            "section_two": section_two
        }
        
    def advance_time(self, weeks=1):
        """Advance the simulation time by specified weeks"""
        self.current_date += timedelta(weeks=weeks)
        print(f"\n⏰ Time advanced to: {self.current_date.strftime('%Y-%m-%d %H:%M:%S')}")
        
    def _find_user(self, user_id):
        """Find user by ID"""
        return next((user for user in self.users if user['user_id'] == user_id), None)
        
    def show_user_progress(self, user_id):
        """Show the progress of a specific user"""
        user = self._find_user(user_id)
        if not user:
            print(f"User {user_id} not found")
            return
            
        print(f"\n=== Progress Report for {user['name']} ===")
        
        print(f"\nCalpro Tests ({len(user['calpro_tests'])}):")
        for i, test in enumerate(user['calpro_tests'], 1):
            date = datetime.fromisoformat(test['date']).strftime('%Y-%m-%d')
            print(f"  {i}. {date} - Concentration: {test['final_concentration']} μg/g, Result: {test['overall_result']}")
            
        print(f"\nHealth Surveys ({len(user['health_surveys'])}):")
        for i, survey in enumerate(user['health_surveys'], 1):
            date = datetime.fromisoformat(survey['date']).strftime('%Y-%m-%d')
            print(f"  {i}. {date} - Survey ID: {survey.get('result_id', 'N/A')}")
            
    def show_all_users_summary(self):
        """Show summary for all users"""
        print(f"\n=== Simulation Summary ===")
        print(f"Current Date: {self.current_date.strftime('%Y-%m-%d %H:%M:%S')}")
        print(f"Total Users: {len(self.users)}")
        
        for user in self.users:
            print(f"\n{user['name']} (ID: {user['user_id']}):")
            print(f"  Calpro Tests: {len(user['calpro_tests'])}")
            print(f"  Health Surveys: {len(user['health_surveys'])}")
            
    def export_simulation_data(self, filename="simulation_results.json"):
        """Export simulation data to JSON file"""
        data = {
            'simulation_date': self.current_date.isoformat(),
            'users': self.users
        }
        
        with open(filename, 'w') as f:
            json.dump(data, f, indent=2)
        print(f"Simulation data exported to {filename}")

def run_interactive_simulation():
    """Run an interactive simulation session"""
    sim = TestSimulation()
    
    print("=== IBD Test Simulation Tool ===")
    print("Commands:")
    print("  add_user <user_id> <name> - Add a user")
    print("  calpro <user_id> - Run Calpro test")
    print("  health <user_id> - Run health survey") 
    print("  advance <weeks> - Advance time by weeks")
    print("  progress <user_id> - Show user progress")
    print("  summary - Show all users summary")
    print("  export - Export data to JSON")
    print("  quit - Exit simulation")
    
    while True:
        try:
            command = input("\n> ").strip().split()
            
            if not command:
                continue
                
            cmd = command[0].lower()
            
            if cmd == "add_user" and len(command) >= 3:
                user_id = command[1]
                name = " ".join(command[2:])
                sim.add_user(user_id, name)
                
            elif cmd == "calpro" and len(command) >= 2:
                user_id = command[1]
                sim.simulate_calpro_test(user_id)
                
            elif cmd == "health" and len(command) >= 2:
                user_id = command[1]
                sim.simulate_health_survey(user_id)
                
            elif cmd == "advance" and len(command) >= 2:
                weeks = int(command[1])
                sim.advance_time(weeks)
                
            elif cmd == "progress" and len(command) >= 2:
                user_id = command[1]
                sim.show_user_progress(user_id)
                
            elif cmd == "summary":
                sim.show_all_users_summary()
                
            elif cmd == "export":
                filename = command[1] if len(command) > 1 else "simulation_results.json"
                sim.export_simulation_data(filename)
                
            elif cmd == "quit":
                print("Ending simulation...")
                break
                
            else:
                print("Invalid command or missing parameters")
                
        except KeyboardInterrupt:
            print("\nEnding simulation...")
            break
        except Exception as e:
            print(f"Error: {e}")

if __name__ == "__main__":
    run_interactive_simulation()
                                </code></pre>
                            </div>
                        </div>
                    </div>

                    <div class="accordion-item bg-white rounded-lg border border-slate-200 overflow-hidden">
                        <button class="accordion-header w-full text-left p-4 bg-slate-100 hover:bg-slate-200 transition">
                            <h3 class="text-xl font-semibold">Predefined Scenarios Script</h3>
                        </button>
                        <div class="accordion-content hidden p-4">
                            <div class="relative">
                                <button onclick="copyToClipboard('code-block-2')" class="absolute top-2 right-2 bg-slate-200 text-slate-700 px-2 py-1 rounded text-xs font-semibold hover:bg-slate-300">Copy</button>
                                <pre class="bg-slate-800 text-white p-4 rounded-md overflow-x-auto"><code id="code-block-2">
from datetime import datetime, timedelta
# The TestSimulation class is assumed to be available,
# typically from importing a module like 'from test_simulation import TestSimulation'
# or if it's defined in the same file. For this snippet, assume it's accessible.

# For this standalone snippet to work, you might need to
# copy the TestSimulation class definition above this part
# or adjust your Python environment's path.
# MOCK TestSimulation for local testing of this snippet if run separately
try:
    from test_simulation import TestSimulation
except ImportError:
    print("TestSimulation class not found, using a simple mock for demonstration.")
    class TestSimulation:
        def __init__(self):
            self.users = []
            self.current_date = datetime.now()
        def add_user(self, user_id, name):
            print(f"MOCK: Added user: {name} (ID: {user_id})")
            self.users.append({'user_id': user_id, 'name': name, 'calpro_tests': [], 'health_surveys': []})
        def simulate_calpro_test(self, user_id):
            print(f"MOCK: Simulating Calpro test for {user_id}. Please input mock data.")
            # Simple mock for input, not fully interactive
            c_score = float(input("MOCK C Score: "))
            t_score = float(input("MOCK T Score: "))
            overall_result = input("MOCK Overall Result: ")
            final_concentration = float(input("MOCK Final Concentration: "))
            user = next((u for u in self.users if u['user_id'] == user_id), None)
            if user:
                user['calpro_tests'].append({'date': datetime.now().isoformat(), 'c_score': c_score, 't_score': t_score, 'overall_result': overall_result, 'final_concentration': final_concentration})
                print("MOCK: Calpro test recorded.")
        def simulate_health_survey(self, user_id):
            print(f"MOCK: Simulating Health Survey for {user_id}. Please input mock data.")
            # Simple mock for input, not fully interactive
            sccai_score = int(input("MOCK SCCAI Question 1 score (0-3): "))
            user = next((u for u in self.users if u['user_id'] == user_id), None)
            if user:
                user['health_surveys'].append({'date': datetime.now().isoformat(), 'section_one': [{'question_id': 1, 'answer_score': sccai_score}]})
                print("MOCK: Health survey recorded.")
        def advance_time(self, weeks):
            self.current_date += timedelta(weeks=weeks)
            print(f"MOCK: Time advanced to: {self.current_date.strftime('%Y-%m-%d %H:%M:%S')}")
        def show_user_progress(self, user_id):
            user = next((u for u in self.users if u['user_id'] == user_id), None)
            if user:
                print(f"MOCK Progress for {user['name']}: Calpro Tests: {len(user['calpro_tests'])}, Health Surveys: {len(user['health_surveys'])}")
            else:
                print(f"MOCK: User {user_id} not found.")
        def show_all_users_summary(self):
            print(f"MOCK Summary: Total Users: {len(self.users)}")
        def export_simulation_data(self, filename):
            print(f"MOCK: Data exported to {filename}")

def scenario_patient_improvement():
    """Simulate a patient showing improvement over time"""
    sim = TestSimulation()
    
    # Add patient
    sim.add_user("patient_001", "John Doe - Improvement Case")
    
    # Week 0 - Initial high inflammation
    print("\n=== Week 0 - Initial Assessment ===")
    sim.simulate_calpro_test("patient_001")
    # Suggested input: C Score: 8.5, T Score: 7.2, Overall: "Elevated", Concentration: 450
    
    sim.simulate_health_survey("patient_001")
    # Suggested SCCAI scores: higher values (2-3 for each question)
    
    # Week 4 - Some improvement
    sim.advance_time(4)
    print("\n=== Week 4 - First Follow-up ===")
    sim.simulate_calpro_test("patient_001")
    # Suggested input: C Score: 6.8, T Score: 5.9, Overall: "Moderate", Concentration: 280
    
    sim.simulate_health_survey("patient_001")
    # Suggested SCCAI scores: lower values (0-1 for each question)
    
    # Week 8 - Continued improvement
    sim.advance_time(4)
    print("\n=== Week 8 - Second Follow-up ===")
    sim.simulate_calpro_test("patient_001")
    # Suggested input: C Score: 4.2, T Score: 3.8, Overall: "Normal", Concentration: 120
    
    sim.simulate_health_survey("patient_001")
    # Suggested SCCAI scores: lower values (0-1 for each question)
    
    # Week 12 - Stable remission
    sim.advance_time(4)
    print("\n=== Week 12 - Final Assessment ===")
    sim.simulate_calpro_test("patient_001")
    # Suggested input: C Score: 2.1, T Score: 2.3, Overall: "Normal", Concentration: 85
    
    sim.show_user_progress("patient_001")
    return sim

def scenario_patient_relapse():
    """Simulate a patient experiencing a relapse"""
    sim = TestSimulation()
    
    # Add patient
    sim.add_user("patient_002", "Jane Smith - Relapse Case")
    
    # Week 0 - Stable condition
    print("\n=== Week 0 - Baseline (Stable) ===")
    sim.simulate_calpro_test("patient_002")
    # Suggested input: C Score: 3.2, T Score: 2.8, Overall: "Normal", Concentration: 95
    
    sim.simulate_health_survey("patient_002")
    # Suggested SCCAI scores: moderate values (1-2 for each question)
    
    # Week 6 - Early signs of flare
    sim.advance_time(6)
    print("\n=== Week 6 - Early Flare Signs ===")
    sim.simulate_calpro_test("patient_002")
    # Suggested input: C Score: 6.5, T Score: 5.2, Overall: "Elevated", Concentration: 320
    
    sim.simulate_health_survey("patient_002")
    # Suggested SCCAI scores: moderate values (1-2 for each question)
    
    # Week 10 - Full relapse
    sim.advance_time(4)
    print("\n=== Week 10 - Full Relapse ===")
    sim.simulate_calpro_test("patient_002")
    # Suggested input: C Score: 9.1, T Score: 8.3, Overall: "Severely Elevated", Concentration: 580
    
    sim.simulate_health_survey("patient_002")
    # Suggested SCCAI scores: high values (2-3 for each question)
    
    sim.show_user_progress("patient_002")
    return sim

def scenario_multiple_patients():
    """Simulate multiple patients with different trajectories"""
    sim = TestSimulation()
    
    # Add multiple patients
    patients = [
        ("patient_003", "Alice Johnson - Stable Case"),
        ("patient_004", "Bob Wilson - Variable Case"),
        ("patient_005", "Carol Brown - Treatment Response")
    ]
    
    for user_id, name in patients:
        sim.add_user(user_id, name)
    
    # Initial tests for all patients
    print("\n=== Week 0 - Initial Assessment for All Patients ===")
    for user_id, name in patients:
        print(f"\nTesting {name}:")
        sim.simulate_calpro_test(user_id)
        
    # 4-week follow-up
    sim.advance_time(4)
    print("\n=== Week 4 - Follow-up Tests ===")
    for user_id, name in patients:
        print(f"\nTesting {name}:")
        sim.simulate_calpro_test(user_id)
        sim.simulate_health_survey(user_id)
        
    sim.show_all_users_summary()
    return sim

if __name__ == "__main__":
    print("Select a scenario:")
    print("1. Patient Improvement")
    print("2. Patient Relapse")
    print("3. Multiple Patients")
    
    choice = input("Enter choice (1-3): ")
    
    if choice == "1":
        sim = scenario_patient_improvement()
    elif choice == "2":
        sim = scenario_patient_relapse()
    elif choice == "3":
        sim = scenario_multiple_patients()
    else:
        print("Invalid choice")
        exit()
    
    # Export results
    sim.export_simulation_data(f"scenario_{choice}_results.json")
    print("\nScenario completed successfully!")
                                </code></pre>
                            </div>
                        </div>
                    </div>

                    <div class="accordion-item bg-white rounded-lg border border-slate-200 overflow-hidden">
                        <button class="accordion-header w-full text-left p-4 bg-slate-100 hover:bg-slate-200 transition">
                            <h3 class="text-xl font-semibold">Setup and Usage</h3>
                        </button>
                        <div class="accordion-content hidden p-4 prose max-w-none">
                            <h4>1. Installation</h4>
                            <p>First, ensure you have Python installed. Then, install the required `time-machine` library using pip:</p>
                            <pre class="bg-slate-800 text-white"><code>pip install time-machine</code></pre>
                            
                            <h4>2. Running the Interactive Simulation</h4>
                            <p>Execute the main script from your terminal:</p>
                            <pre class="bg-slate-800 text-white"><code>python scripts/simulation/test_simulation.py</code></pre>
                            
                            <h4>3. Example Commands</h4>
                            <p>Once the simulation is running, you can use the following commands:</p>
                            <pre class="bg-slate-800 text-white"><code>&gt; add_user USER001 John Doe
&gt; calpro USER001
(Enter test data when prompted)
&gt; advance 4
&gt; health USER001
&gt; progress USER001
&gt; export results.json
&gt; quit</code></pre>
                        </div>
                    </div>
                </div>
            </section>
        </main>
    </div>

    <!-- Custom Alert/Message Box -->
    <div id="custom-alert" class="fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center hidden z-50">
        <div class="bg-white p-6 rounded-lg shadow-xl max-w-sm w-full text-center">
            <p id="alert-message" class="text-lg text-slate-700 mb-4"></p>
            <button onclick="document.getElementById('custom-alert').classList.add('hidden')" class="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700">OK</button>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const simulationData = {
                flareToRemission: {
                    name: "Patient A: Active Flare → Remission",
                    labels: ['Week 0', 'Week 4', 'Week 8', 'Week 12'],
                    data: [
                        { week: 0, c_score: 9.2, t_score: 8.7, overall_result: 'Severely Elevated', final_concentration: 620.0 },
                        { week: 4, c_score: 7.8, t_score: 7.1, overall_result: 'Elevated', final_concentration: 480.0 },
                        { week: 8, c_score: 5.2, t_score: 4.8, overall_result: 'Moderate', final_concentration: 220.0 },
                        { week: 12, c_score: 2.8, t_score: 2.3, overall_result: 'Normal', final_concentration: 95.0 }
                    ]
                },
                stableToRelapse: {
                    name: "Patient B: Stable → Relapse",
                    labels: ['Week 0', 'Week 8', 'Week 12', 'Week 16'],
                    data: [
                        { week: 0, c_score: 2.1, t_score: 1.8, overall_result: 'Normal', final_concentration: 45.0 },
                        { week: 8, c_score: 2.4, t_score: 2.1, overall_result: 'Normal', final_concentration: 52.0 },
                        { week: 12, c_score: 4.7, t_score: 4.2, overall_result: 'Elevated', final_concentration: 180.0 },
                        { week: 16, c_score: 8.1, t_score: 7.6, overall_result: 'Severely Elevated', final_concentration: 520.0 }
                    ]
                },
                stable: {
                    name: "Patient C: Consistently Stable",
                    labels: ['Week 0', 'Week 6', 'Week 12'],
                    data: [
                        { week: 0, c_score: 3.2, t_score: 2.9, overall_result: 'Normal', final_concentration: 85.0 },
                        { week: 6, c_score: 3.8, t_score: 3.1, overall_result: 'Normal', final_concentration: 92.0 },
                        { week: 12, c_score: 2.9, t_score: 2.7, overall_result: 'Normal', final_concentration: 78.0 }
                    ]
                }
            };

            const scenarioSelect = document.getElementById('scenario-select');
            const chartTitle = document.getElementById('chart-title');
            
            const metricCScore = document.querySelector('#metric-c-score span');
            const metricTScore = document.querySelector('#metric-t-score span');
            const metricConcentration = document.querySelector('#metric-concentration span');
            const metricResult = document.querySelector('#metric-result span');
            const generateInterpretationBtn = document.getElementById('generate-interpretation');
            const interpretationOutput = document.getElementById('interpretation-output');
            const interpretationText = document.getElementById('interpretation-text');
            const interpretationLoading = document.getElementById('interpretation-loading');


            const ctx = document.getElementById('concentrationChart').getContext('2d');
            const concentrationChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Final Concentration (μg/g)',
                        data: [],
                        borderColor: '#3b82f6',
                        backgroundColor: 'rgba(59, 130, 246, 0.1)',
                        borderWidth: 2,
                        fill: true,
                        tension: 0.1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Concentration (μg/g)'
                            }
                        },
                        x: {
                             title: {
                                display: true,
                                text: 'Time'
                            }
                        }
                    },
                    plugins: {
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const scenarioKey = scenarioSelect.value;
                                    const dataPoint = simulationData[scenarioKey].data[context.dataIndex];
                                    return [
                                        `Concentration: ${dataPoint.final_concentration} µg/g`,
                                        `C-Score: ${dataPoint.c_score}`,
                                        `T-Score: ${dataPoint.t_score}`,
                                        `Result: ${dataPoint.overall_result}`
                                    ];
                                }
                            }
                        },
                        legend: {
                            display: false
                        }
                    },
                    onHover: (event, chartElement) => {
                         if (chartElement.length > 0) {
                            const dataIndex = chartElement[0].index;
                            const scenarioKey = scenarioSelect.value;
                            const dataPoint = simulationData[scenarioKey].data[dataIndex];
                            updateMetrics(dataPoint);
                        }
                    }
                }
            });

            function updateMetrics(dataPoint) {
                metricCScore.textContent = dataPoint.c_score;
                metricTScore.textContent = dataPoint.t_score;
                metricConcentration.textContent = dataPoint.final_concentration;
                metricResult.textContent = dataPoint.overall_result;
            }
            
            function resetMetrics() {
                 const scenarioKey = scenarioSelect.value;
                 const lastDataPoint = simulationData[scenarioKey].data[simulationData[scenarioKey].data.length - 1];
                 updateMetrics(lastDataPoint);
            }

            function updateChart() {
                const selectedScenarioKey = scenarioSelect.value;
                const selectedData = simulationData[selectedScenarioKey];

                chartTitle.textContent = selectedData.name;
                concentrationChart.data.labels = selectedData.labels;
                concentrationChart.data.datasets[0].data = selectedData.data.map(d => d.final_concentration);
                concentrationChart.update();
                resetMetrics();
                interpretationOutput.classList.add('hidden'); 
                interpretationText.textContent = '';
            }

            scenarioSelect.addEventListener('change', updateChart);
            
            document.getElementById('concentrationChart').addEventListener('mouseleave', resetMetrics);

            updateChart();

            const navButtons = document.querySelectorAll('.nav-button');
            const sections = document.querySelectorAll('.page-section');
            const navContainer = document.getElementById('nav-container');

            navContainer.addEventListener('click', (e) => {
                if (e.target.classList.contains('nav-button')) {
                    const targetId = e.target.dataset.target;

                    navButtons.forEach(button => {
                        button.classList.remove('active');
                    });
                    e.target.classList.add('active');

                    sections.forEach(section => {
                        if (section.id === targetId) {
                            section.classList.remove('hidden');
                        } else {
                            section.classList.add('hidden');
                        }
                    });
                }
            });

            const accordionHeaders = document.querySelectorAll('.accordion-header');
            accordionHeaders.forEach(header => {
                header.addEventListener('click', () => {
                    const content = header.nextElementSibling;
                    content.classList.toggle('hidden');
                });
            });

            // LLM Integration
            generateInterpretationBtn.addEventListener('click', async () => {
                const selectedScenarioKey = scenarioSelect.value;
                const patientData = simulationData[selectedScenarioKey].data;

                interpretationOutput.classList.remove('hidden');
                interpretationText.textContent = '';
                interpretationLoading.classList.remove('hidden');

                try {
                    let chatHistory = [];
                    const prompt = `You are a medical assistant specialized in IBD data interpretation. Analyze the following patient's Calprotectin test results over time and provide a concise summary of their likely IBD activity and progression. Focus on changes in final concentration, C-Score, T-Score, and overall result.
                    Patient Data (JSON format):
                    ${JSON.stringify(patientData, null, 2)}
                    Summary:`;
                    
                    chatHistory.push({ role: "user", parts: [{ text: prompt }] });
                    const payload = { contents: chatHistory };
                    const apiKey = ""; 
                    const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;

                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    const result = await response.json();

                    // DEBUGGING: Log the full API response for inspection
                    console.log('Gemini API response:', result);
                    // END DEBUGGING

                    if (result.candidates && result.candidates.length > 0 &&
                        result.candidates[0].content && result.candidates[0].content.parts &&
                        result.candidates[0].content.parts.length > 0) {
                        if (result.candidates[0].finishReason === 'SAFETY') {
                             interpretationText.textContent = 'Unable to generate interpretation due to safety concerns. Please adjust the input or try again.';
                             showCustomAlert('Content generation blocked due to safety policy. Please adjust the input.');
                             return; 
                        }
                        const text = result.candidates[0].content.parts[0].text;
                        interpretationText.textContent = text;
                    } else if (result.error) {
                        interpretationText.textContent = `API Error: ${result.error.message || 'Unknown API error'}`;
                        showCustomAlert(`API Error: ${result.error.message || 'Unknown API error'}. Check console for details.`);
                    } else {
                        interpretationText.textContent = 'Failed to get interpretation. Unexpected API response structure or no text generated.';
                        showCustomAlert('Failed to get interpretation. Unexpected API response structure or no text generated. Check console for details.');
                    }
                } catch (error) {
                    console.error('Error generating interpretation:', error);
                    interpretationText.textContent = 'Error generating interpretation. Please check your console for details.';
                    showCustomAlert('An error occurred while generating interpretation. Please check console for details.');
                } finally {
                    interpretationLoading.classList.add('hidden');
                }
            });
        });

        function showCustomAlert(message) {
            document.getElementById('alert-message').textContent = message;
            document.getElementById('custom-alert').classList.remove('hidden');
        }

        function copyToClipboard(elementId) {
            const codeEl = document.getElementById(elementId);
            const text = codeEl.innerText;
            
            const textarea = document.createElement('textarea');
            textarea.value = text;
            document.body.appendChild(textarea);
            textarea.select();
            try {
                document.execCommand('copy');
                showCustomAlert('Code copied to clipboard!');
            } catch (err) {
                showCustomAlert('Failed to copy code. Your browser might not support this feature directly.');
            }
            document.body.removeChild(textarea);
        }
    </script>
</body>
</html>
